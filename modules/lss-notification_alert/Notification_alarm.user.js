(function($, I18n) {
    let LSS_NOTIFICATION_STORAGE = "LSS_NOTIFICATION_STORAGE";

  I18n.translations.de_DE.lssm['n-alarm'] = {
    not_support: "Dieser Browser unterstützt leider keine HTML5-Notifications",
    inithead: "Initalisierung",
    chat_message: "Chatnachricht von ",
    blend: "Ausblenden nach:",
    seconds: "Sekunden",
    settings: {
      title: "Notification-Alarm",
      chat_title: "Chatnachrichten",
      chat_text: "Chatnachrichten als Notification bekommen.",
      s5_title: "Status 5",
      save: "Speichern",
      close: "Schließen",
      s5_text: "Status 5 als Notification bekommen",
      status_title: "Status",
      status_text: "Alle Status-Meldungen als Notification bekommen.",
      chatp_title: "Chatnachrichten als Info-Popup",
      chatp_text: "Alle Chatnachrichten auch als Popup-Nachrichten am rechten Rand anzeigen"
    }
  }

  I18n.translations.en_US.lssm['n-alarm'] = {
    not_support: "This browser doesn't support HTML5-Notifications",
    inithead: "Initalization",
    chat_message: "Chat message from ",
    blend: "Hide after:",
    seconds: "seconds",
    settings: {
      title: "Notification-Alert",
      chat_title: "Chat messages",
      chat_text: "Get chat messages as notification.",
      s5_title: "Transport Request",
      save: "Save",
      close: "Close",
      s5_text: "Get Transport Requests as notification",
      status_title: "Status",
      status_text: "Get all status messages as notification.",
      chatp_title: "Get chat messages as info popup",
      chatp_text: "Get all chat messages as popup message on the right side"
    }
  }

  I18n.translations.es_ES.lssm['n-alarm'] = {
    not_support: "Este navegador no soporta Notificaciones HTML5",
    inithead: "Initalización",
    chat_message: "Mensaje de chat de ",
    blend: "Ocultar después:",
    seconds: "segunda porción",
    settings: {
      title: "Notificación-Alerta",
      chat_title: "Mensajes de chat",
      chat_text: "Recibe mensajes de chat como notificación.",
      s5_title: "Solicitud de transporte",
      save: "Guardar",
      close: "Cerrar",
      s5_text: "Obtener órdenes de transporte como notificación",
      status_title: "Estado",
      status_text: "Obtenga todos los mensajes de estado como notificación.",
      chatp_title: "Obtener mensajes de chat como ventana emergente de información",
      chatp_text: "Obtener todos los mensajes de chat como mensaje emergente en el lado derecho"
    }
  }

  I18n.translations.pt_PT.lssm['n-alarm'] = {
    not_support: "Este navegador não suporta notificações HTML5",
    inithead: "Inicialização",
    chat_message: "Mensagem de chat de ",
    blend: "Esconder-se depois:",
    seconds: "segundos",
    settings: {
      title: "Alerta de notificação",
      chat_title: "Mensagens de chat",
      chat_text: "Obtenha mensagens de chat como notificação.",
      s5_title: "Pedido de Transporte",
      save: "Salvar",
      close: "Fechar",
      s5_text: "Obtenha Pedidos de Transporte como notificação",
      status_title: "Estado",
      status_text: "Obtenha todas as mensagens de estado como notificação.",
      chatp_title: "Obtenha mensagens de chat como popup de informação",
      chatp_text: "Obtenha todas as mensagens de chat como mensagem popup no lado direito"
    }
  }

  I18n.translations.cs_CZ.lssm['n-alarm'] = {
    not_support: "Tento prohlížeč nepodporuje oznámení HTML5",
    inithead: "Inicializace",
    chat_message: "Chatová zpráva od ",
    blend: "Skrýt za:",
    seconds: "sekundy",
    settings: {
      title: "Oznámení-upozornění",
      chat_title: "Chatovací zprávy",
      chat_text: "Získejte zprávy chatu jako upozornění.",
      s5_title: "Žádost o přepravu",
      save: "Uložit",
      close: "Zavřít",
      s5_text: "Získejte oznámení o přepravě jako oznámení",
      status_title: "Postavení",
      status_text: "Získejte všechny zprávy o stavu jako upozornění.",
      chatp_title: "Získejte zprávy chatu jako informační vyskakovací okno",
      chatp_text: "Získejte všechny chatové zprávy jako vyskakovací zprávu na pravé straně"
    }
  }

  I18n.translations.pl_PL.lssm['n-alarm'] = {
    not_support: "Ta przeglądarka nie obsługuje powiadomień HTML5.",
    inithead: "Initalizacja",
    chat_message: "Wiadomość czatowa od ",
    blend: "Ukryj się potem:",
    seconds: "sekundy",
    settings: {
      title: "Powiadomienie-Alert",
      chat_title: "Wiadomości czatowe",
      chat_text: "Uzyskaj wiadomości na czacie jako powiadomienie.",
      s5_title: "Wniosek o transport",
      save: "Oszczędzaj.",
      close: "Zamknij się.",
      s5_text: "Pobierz wnioski o transport jako powiadomienie",
      status_title: "Status",
      status_text: "Uzyskaj wszystkie komunikaty o statusie jako powiadomienie.",
      chatp_title: "Pobierz wiadomości na czacie jako okienko informacyjne",
      chatp_text: "Pobierz wszystkie wiadomości czatu jako wiadomość wyskakującą po prawej stronie"
    }
  }

  I18n.translations.sv_SE.lssm['n-alarm'] = {
    not_support: "Den här webbläsaren stöder inte HTML5-aviseringar",
    inithead: "initiering",
    chat_message: "Chattmeddelande från",
    blend: "Göm efter:",
    seconds: "sekunder",
    settings: {
      title: "Anmälan-Alert",
      chat_title: "Chatta meddelanden",
      chat_text: "Få chattmeddelanden som avisering.",
      s5_title: "Transportförfrågan",
      save: "Spara",
      close: "Stänga",
      s5_text: "Få transportförfrågningar som anmälan",
      status_title: "Status",
      status_text: "Få alla statusmeddelanden som avisering.",
      chatp_title: "Få chattmeddelanden som popup-information",
      chatp_text: "Få alla chattmeddelanden som popup-meddelande på höger sida"
    }
  }

  I18n.translations.da_DK.lssm['n-alarm'] = {
    not_support: "Denne browser understøtter ikke HTML5-meddelelser",
    inithead: "Initialisering",
    chat_message: "Chatbesked fra ",
    blend: "Skjul efter:",
    seconds: "sekunder",
    settings: {
      title: "Meddelelse-Alert",
      chat_title: "Chatbeskeder",
      chat_text: "Få chatbeskeder som anmeldelse.",
      s5_title: "Transportanmodning",
      save: "Gemme",
      close: "Tæt",
      s5_text: "Få transportanmodninger som anmeldelse",
      status_title: "Status",
      status_text: "Få alle statusmeddelelser som anmeldelse.",
      chatp_title: "Hent chatbeskeder som informations popup",
      chatp_text: "Hent alle chatbeskeder som popup-besked i højre side"
    }
  }

  I18n.translations.nb_NO.lssm['n-alarm'] = {
    not_support: "Denne nettleseren støtter ikke HTML5-varsler",
    inithead: "initialisering",
    chat_message: "Chat melding fra ",
    blend: "Skjul etter:",
    seconds: "sekunder",
    settings: {
      title: "Varsling-varsel",
      chat_title: "Chatmeldinger",
      chat_text: "Få chat-meldinger som varsling.",
      s5_title: "Transportforespørsel",
      save: "Lagre",
      close: "Lukk",
      s5_text: "Få transportforespørsler som varsling",
      status_title: "Status",
      status_text: "Få alle statusmeldinger som varsling.",
      chatp_title: "Få chattemeldinger som informasjons popup",
      chatp_text: "Få alle chatmeldinger som popup-melding på høyre side"
    }
  }

  I18n.translations.it_IT.lssm['n-alarm'] = {
    not_support: "Questo browser non supporta le notifiche HTML5-Notifiche",
    inithead: "Initalizzazione",
    chat_message: "Messaggio chat da ",
    blend: "Nascondersi dopo:",
    seconds: "secondi",
    settings: {
      title: "Allarme di notifica",
      chat_title: "Messaggi di chat",
      chat_text: "Ricevi i messaggi di chat come notifica.",
      s5_title: "Richiesta di trasporto",
      save: "Risparmiare",
      close: "Chiudere",
      s5_text: "Richieste di trasporto come notifica",
      status_title: "Status",
      status_text: "Ricevi tutti i messaggi di stato come notifica.",
      chatp_title: "Ricevi i messaggi di chat come popup informativo",
      chatp_text: "Ricevi tutti i messaggi di chat come messaggio popup sul lato destro"
    }
  }

  I18n.translations.tr_TR.lssm['n-alarm'] = {
    not_support: "Bu tarayıcı HTML5-Bildirimlerini desteklemiyor",
    inithead: "Başlatma",
    chat_message: "Adlı kişiden gelen sohbet mesajı ",
    blend: "Sonra gizle:",
    seconds: "saniye",
    settings: {
      title: "Bildirim-Uyarısı",
      chat_title: "Sohbet mesajları",
      chat_text: "Sohbet mesajlarını bildirim olarak alın.",
      s5_title: "Taşıma Talebi",
      save: "Kaydetmek",
      close: "Yakın",
      s5_text: "Aktarım Isteklerini bildirim olarak alma",
      status_title: "Durum",
      status_text: "Tüm durum iletilerini bildirim olarak alın.",
      chatp_title: "Bilgi açılır pencere olarak sohbet mesajları alma",
      chatp_text: "Tüm sohbet mesajlarını sağ tarafta açılır ileti olarak alın"
    }
  }

  I18n.translations.fr_FR.lssm['n-alarm'] = {
    not_support: "Ce navigateur ne supporte pas les notifications HTML5.",
    inithead: "Initalisation",
    chat_message: "Message instantané de la part de ",
    blend: "Cachez-vous après :",
    seconds: "secondes",
    settings: {
      title: "Notification-Alerte",
      chat_title: "Messages de clavardage",
      chat_text: "Recevoir les messages de chat comme notification.",
      s5_title: "Demande de transport",
      save: "Sauvegarder",
      close: "Fermer",
      s5_text: "Obtenir les demandes de transport comme notification",
      status_title: "Statut",
      status_text: "Obtenir tous les messages d'état comme notification.",
      chatp_title: "Obtenir des messages de chat sous forme de popup d'information",
      chatp_text: "Obtenir tous les messages du chat sous forme de message popup sur le côté droit"
    }
  }

  I18n.translations.ru_RU.lssm['n-alarm'] = {
    not_support: "Этот браузер не поддерживает HTML5-уведомления.",
    inithead: "Инитализация",
    chat_message: "Сообщение чата от ",
    blend: "Спрячься после:",
    seconds: "секунды",
    settings: {
      title: "Уведомление-оповещение-оповещение",
      chat_title: "Сообщения чата",
      chat_text: "Получать сообщения в чате в качестве уведомления.",
      s5_title: "Запрос на транспортировку",
      save: "Сохранить",
      close: "Близко",
      s5_text: "Получать запросы на транспортировку в качестве уведомления",
      status_title: "Статус",
      status_text: "Получать все сообщения о состоянии в виде уведомлений.",
      chatp_title: "Получать сообщения чата в виде всплывающего окна информации",
      chatp_text: "Получить все сообщения чата в виде всплывающего сообщения на правой стороне экрана."
    }
  }

  I18n.translations.uk_UA.lssm['n-alarm'] = {
    not_support: "Цей браузер не підтримує HTML5-сповіщення",
    inithead: "Ініціалізація",
    chat_message: "Повідомлення чату від ",
    blend: "Сховати після:",
    seconds: "секунд",
    settings: {
      title: "Повідомлення-Повідомлення",
      chat_title: "Повідомлення чату",
      chat_text: "Отримуйте повідомлення в чаті як сповіщення.",
      s5_title: "Запит на транспорт",
      save: "Зберегти",
      close: "Закрити",
      s5_text: "Отримайте запити на транспорт як повідомлення",
      status_title: "Статус",
      status_text: "Отримати всі повідомлення про стан як сповіщення.",
      chatp_title: "Отримуйте повідомлення в чаті як спливаюче повідомлення",
      chatp_text: "Отримайте всі повідомлення в чаті як спливаюче повідомлення праворуч"
    }
  }

  I18n.translations.ja_JP.lssm['n-alarm'] = {
    not_support: "このブラウザはHTML5-Notificationsをサポートしていません",
    inithead: "初期化",
    chat_message: "からのチャットメッセージ ",
    blend: "後に隠す：",
    seconds: "秒",
    settings: {
      title: "通知アラート",
      chat_title: "チャットメッセージ",
      chat_text: "通知としてチャットメッセージを取得します。",
      s5_title: "輸送依頼",
      save: "セーブ",
      close: "閉じる",
      s5_text: "通知としてトランスポートリクエストを取得する",
      status_title: "状態",
      status_text: "すべてのステータスメッセージを通知として取得します。",
      chatp_title: "情報ポップアップとしてチャットメッセージを取得する",
      chatp_text: "すべてのチャットメッセージを右側のポップアップメッセージとして取得する"
    }
  }

  I18n.translations.ko_KR.lssm['n-alarm'] = {
    not_support: "이 브라우저는 HTML5 알림을 지원하지 않습니다",
    inithead: "초기화",
    chat_message: "님의 채팅 메시지 ",
    blend: "후 숨기기 :",
    seconds: "초",
    settings: {
      title: "알림 알림",
      chat_title: "채팅 메시지",
      chat_text: "채팅 메시지를 알림으로받습니다.",
      s5_title: "운송 요청",
      save: "저장",
      close: "닫기",
      s5_text: "전송 요청을 알림으로 가져 오기",
      status_title: "상태",
      status_text: "모든 상태 메시지를 알림으로받습니다.",
      chatp_title: "정보 팝업으로 채팅 메시지 받기",
      chatp_text: "오른쪽에 모든 채팅 메시지를 팝업 메시지로 표시"
    }
  }

  I18n.translations.ro_RO.lssm['n-alarm'] = {
    not_support: "Acest browser nu acceptă notificări HTML5",
    inithead: "Initalizare",
    chat_message: "Mesaj de chat de la ",
    blend: "Ascunde după:",
    seconds: "Secunde",
    settings: {
      title: "Notificare-Alertă",
      chat_title: "Cat mesaje",
      chat_text: "Obțineți mesajele de chat ca notificare.",
      s5_title: "Cerere de transport",
      save: "Salva",
      close: "Închide",
      s5_text: "Obțineți solicitările de transport ca notificare",
      status_title: "Starea",
      status_text: "Obțineți toate mesajele de stare ca notificare.",
      chatp_title: "Obțineți mesaje de chat ca informații pop-up",
      chatp_text: "Obținetoate mesajele de chat ca mesaj pop-up în partea dreaptă"
    }
  }

  I18n.translations.nl_NL.lssm['n-alarm'] = {
    not_support: "Deze browser ondersteunt helaas geen HTML5-meldingen",
    inithead: "Aan het laden",
    chat_message: "Chatbericht van ",
    blend: "Vervagen na:",
    seconds: "seconden",
    settings: {
      title: "Meldingen-Alarm",
      chat_title: "Chatmeldingen",
      chat_text: "Ontvang notificaties van nieuwe berichten in de chat.",
      s5_title: "Spraakaanvragen",
      save: "Opslaan",
      s5_text: "Ontvang notificaties van spraakaanvragen",
      status_title: "Status",
      status_text: "Ontvang notificaties van alle status-meldingen.",
      chatp_title: "Chatberichten als Info-Popup",
      chatp_text: "Alle chatberichten ook als Popup-berichten aan de rechter rand van het scherm tonen"
    }
  }

    let managedSettings = {
    "id": LSS_NOTIFICATION_STORAGE,
    "title": I18n.t('lssm.n-alarm.settings.title'),
    "settings": {
      "n-alarm-chat": {
        "default": true,
        "ui": {
          "label": I18n.t('lssm.n-alarm.settings.chat_title'),
          "type": "toggle",
          "description": I18n.t('lssm.n-alarm.settings.chat_text')
        }
      },
      "n-alarm-timeout-chat": {
        "default": 3,
        "ui": {
          "label": I18n.t('lssm.n-alarm.blend'),
          "type": "int",
          "parent": LSS_NOTIFICATION_STORAGE + "_n-alarm-chat_toggle",
          "class": "panel-footer"
        }
      },
      "n-alarm-s5": {
        "default": true,
        "ui": {
          "label": I18n.t('lssm.n-alarm.settings.s5_title'),
          "type": "toggle",
          "description": I18n.t('lssm.n-alarm.settings.s5_text')
        }
      },
      "n-alarm-timeout-s5": {
        "default": 3,
        "ui": {
          "label": I18n.t('lssm.n-alarm.blend'),
          "type": "int",
          "parent": LSS_NOTIFICATION_STORAGE + "_n-alarm-s5_toggle",
          "class": "panel-footer"
        }
      },
      "n-alarm-status": {
        "default": true,
        "ui": {
          "label": I18n.t('lssm.n-alarm.settings.status_title'),
          "type": "toggle",
          "description": I18n.t('lssm.n-alarm.settings.status_text')
        }
      },
      "n-alarm-timeout-status": {
        "default": 3,
        "ui": {
          "label": I18n.t('lssm.n-alarm.blend'),
          "type": "int",
          "parent": LSS_NOTIFICATION_STORAGE + "_n-alarm-status_toggle",
          "class": "panel-footer"
        }
      },
      "n-alarm-chatp": {
        "default": true,
        "ui": {
          "label": I18n.t('lssm.n-alarm.settings.chatp_title'),
          "type": "toggle",
          "description": I18n.t('lssm.n-alarm.settings.chatp_text')
        }
      },
      "n-alarm-timeout-chatp": {
        "default": 3,
        "ui": {
          "label": I18n.t('lssm.n-alarm.blend'),
          "type": "int",
          "parent": LSS_NOTIFICATION_STORAGE + "_n-alarm-chatp_toggle",
          "class": "panel-footer"
        }
      }
    }
  };

  lssm.managedSettings.register(managedSettings);

  function notifyMe(username, message, type = "init", fms = "2", vid = "0") {
      let notification;
    if (!("Notification" in window)) {
      alert(I18n.t('lssm.n-alarm.not_support'));
    } else if (Notification.permission === "granted") {

      if (type === "Chat") {
        notification = new Notification(I18n.t('lssm.n-alarm.chat_message') + username, {
          body: message,
          icon: lssm.getlink("/modules/lss-notification_alert/img/134895.png")
        });
        setTimeout(function() {
          notification.close();
        }, getSetting('n-alarm-timeout-chat') * 1000);
        notification.onclick = function() {
          window.focus();
        };
      } else if (type === "Status") {
        notification = new Notification(username, {
          body: message,
          icon: lssm.getlink("/modules/lss-notification_alert/img/Status_" + fms + ".png"),
        });
        setTimeout(function() {
          notification.close();
        }, getSetting('n-alarm-timeout-status') * 1000);
        notification.onclick = function() {

          $("body").append('<a href="/vehicles/' + vid + '" id="v_' + vid + '_' + fms + '" class="btn btn-xs btn-default lightbox-open">' + username + '</a>');
          $('#v_' + vid + '_' + fms + '').click();
          window.focus();
          $('#v_' + vid + '_' + fms + '').remove();
        };
      } else if (type === "S5") {
        notification = new Notification(username, {
          body: message,
          icon: lssm.getlink("/modules/lss-notification_alert/img/Status_" + fms + ".png"),
        });
        setTimeout(function() {
          notification.close();
        }, getSetting('n-alarm-timeout-s5') * 1000);
        notification.onclick = function() {

          $("body").append('<a href="/vehicles/' + vid + '" id="v_' + vid + '_' + fms + '" class="btn btn-xs btn-default lightbox-open">' + username + '</a>');
          $('#v_' + vid + '_' + fms + '').click();
          window.focus();
          $('#v_' + vid + '_' + fms + '').remove();
        };
      }

    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission(function(permission) {
        if (permission === "granted") {
          // TODO: I18n
          new Notification("Benachrichtungen aktiviert!");
        }
      });
    }


  }
    let $mainDiv = $('<div id="chatNote" class="panel panel-default"><div class="panel-heading">Chat</div></div>');
  $mainDiv.css({
    'position': 'fixed',
    'width': '250px',
    'z-index': '99999',
    'margin-left': '-255px',
    'top': '20%',
    'left': '100%',
    'display': 'none',
    'cursor': 'pointer'
  });
  $mainDiv.click(function() {
    $(this).hide('slow');
  });
    let $contentDiv = $('<div class="panel-body" style="background-color: white;"></div>');
    let $ul = $('<ul id="chatNoteUl"></ul>');
  $ul.css({
    'list-style': 'none',
    'margin-left': '0',
    'padding-left': ' 20px'
  });
  $ul.appendTo($contentDiv);
  $contentDiv.appendTo($mainDiv);
  $mainDiv.appendTo($('body'));
    let MainDivTimer;

  function hideMainDiv() {
    clearTimeout(MainDivTimer);
    MainDivTimer = setTimeout(function() {
      $mainDiv.hide('slow');
    }, getSetting('n-alarm-timeout-chatp') * 1000);
  }

  function ChatPopup(date, user_id, username, mission_id, message) {
      let e = "<li><span class='mission_chat_message_username'>[" + date + "] <a href='/profile/" + user_id + "' class='lightbox-open'>" + username + ":</a></span>";
    mission_id && (e = e + "<a href='/missions/" + mission_id + "' class='lightbox-open'><span class='glyphicon glyphicon-bell'></span></a> ");
    e = e + " " + message + "</li>";
    $(e).appendTo($ul).delay(getSetting('n-alarm-timeout-chatp') * 1000).hide('slow', function() {
      $(this).remove();
    });
    $mainDiv.show('slow');
    hideMainDiv();

  }

  // Bind alliance chat event
  $(document).bind(lssm.hook.postname("allianceChat"), function(event, t) {
    if (user_id !== t.user_id && getSetting('n-alarm-chat') && !getSetting('n-alarm-chatp')) {
      notifyMe(t.username, t.message, "Chat");
    } else if (user_id !== t.user_id && getSetting('n-alarm-chatp') && !getSetting('n-alarm-chat')) {
      ChatPopup(t.date, t.user_id, t.username, t.mission_id, t.message);
    } else if (user_id !== t.user_id && getSetting('n-alarm-chatp') && getSetting('n-alarm-chat')) {
      ChatPopup(t.date, t.user_id, t.username, t.mission_id, t.message);
      notifyMe(t.username, t.message, "Chat");
    }
  });

  // Bind S5 FMS event
  $(document).bind(lssm.hook.postname("radioMessage"), function(event, t) {
    if (t.fms_real == 5 && getSetting('n-alarm-s5')) {
      // TODO: I18n
      if (t.fms_text.startsWith("[Verband]")) {
        if (!alliance_ignore_fms) {
          notifyMe(t.caption, t.fms_text, "S5", t.fms_real, t.id);
        }
      } else {
        notifyMe(t.caption, t.fms_text, "S5", t.fms_real, t.id);
      }
    } else if (t.fms_real != 5 && getSetting('n-alarm-status')) {
      // TODO: I18n
      if (t.fms_text.startsWith("[Verband]")) {
        if (!alliance_ignore_fms) {
          notifyMe(t.caption, t.fms_text, "Status", t.fms_real, t.id);
        }
      } else {
        notifyMe(t.caption, t.fms_text, "Status", t.fms_real, t.id);
      }
    }
  });

  function getSetting(setting) {
    return lssm.managedSettings.getSetting(LSS_NOTIFICATION_STORAGE, setting);
  }
})($, I18n);
